<!DOCTYPE html><html><head>
    <style>
        html {
            font-size: 62.5%;
        }
        body {
            font-size: 1.5em;
            line-height: 1.6;
            font-weight: 400;
            font-family: "SF Pro Text", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
            margin: 0;
            padding: 0;
            color: #777;
            background: #ecf0f3;
        }
        #section_container {
            position: relative;
            background: #ecf0f3;
        }
        #background {
            background: #ebedef;
            border-left: 1px solid #e2e2eb;
            position: absolute;
            top: 0;
            left: 40%;
            right: 0;
            bottom: 0;
            z-index: 0;
            display: none;
        }
        @media (min-width: 768px) {
            #background {
                display: block;
            }
        }
        a {
            color: #666;
        }
        a:visited {
            color: #777;
        }
        a.parent {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 12px;
            margin-right: 10px;
            text-decoration: none;
        }
        a.parent:after {
            content: ">";
            font-size: 14px;
            margin-left: 4px;
        }
    </style>
    
    <style>
        div.section:hover {
            background: #f8fafb;
        }
        div.section {
            position: relative;
        }
        div.section:after {
            clear: both;
            content: "";
            display: block;
        }
        div.section {
            border-top: 1px solid #e2e2eb;
        }
        div.footer {
            margin-top: 25px;
            position: relative;
            padding: 10px 0;
            text-align: center;
        }
        div.footer a {
            display: inline-block;
            margin: 8px;
            font-size: 1.3rem;
        }
        div.footer {
            background: #d5dbe0;
        }
    </style>
    <style>pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }

.highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #9C6500 } /* Comment.Preproc */
.highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #E40000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #008400 } /* Generic.Inserted */
.highlight .go { color: #717171 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #687822 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #767600 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #A45A77 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
        <style>
        div.section:hover div.code {
            background: #f8fafb;
        }
        div.section div.code {
            background: #ebedef;
              padding: 14px 8px 16px 15px;
              vertical-align: top;
        }
        @media (min-width: 768px) {
            div.section div.code {
                margin-left: 40%;
            }
        }
        </style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/mathtex-script-type.min.js" defer></script>
        <style>
            div.section div.doc {
                box-sizing: border-box;
                padding: 10px 8px 1px 8px;
                vertical-align: top;
                text-align: left;
                word-break: break-all;
            }
        @media (min-width: 768px) {
            div.section div.doc {
                float: left;
                width: 40%;
                min-height: 5px;
            }
        }
        @media (min-width: 1024px) {
            div.section div.doc {
                padding: 10px 25px 1px 50px;
            }
        }
        div.section div.doc img {
            max-width: 100%;
            transition:transform 0.25s ease;
        }
        img:hover {
            -webkit-transform:scale(1.75);
            transform:scale(1.75);
        }        
        </style>
        </head><body><div id="section_container"><div id="background"></div>
    <div class="section" id="0">
        
        <div class="doc">
            <p><a class="parent" href="../../index.html">Home</a><a class="parent" href="../index.html">Model</a><a class="parent" href="index.html">MSDiSe</a></p>
        </div>
        
    </div>
    
    <div class="section" id="1">
        
        <div class="doc">
            <p><br><br></p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">omegaconf</span>
<span class="kn">from</span> <span class="nn">source.Logger.logger</span> <span class="kn">import</span> <span class="n">log_error</span>
<span class="kn">from</span> <span class="nn">source.LR_Scheduler.oneCycleLearningRatePolicy</span> <span class="kn">import</span> <span class="n">OneCycleLR</span>
<span class="kn">from</span> <span class="nn">source.Loss.l1l2_loss</span> <span class="kn">import</span> <span class="n">SmoothL1_Loss</span>
<span class="kn">from</span> <span class="nn">source.Model.modelWrapper</span> <span class="kn">import</span> <span class="n">ModelWrapper</span>
<span class="kn">from</span> <span class="nn">omegaconf.dictconfig</span> <span class="kn">import</span> <span class="n">DictConfig</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="2">
        
        <div class="doc">
            <h1>Model Wrapper for Disparity pretraining task using MSDiSe</h1>
<p>Custom model wrapper class to setup the current process regarding a disparity pretraining procedure task using 
MSDiSe as the network architecture.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MSDiSe_Disparity_ModelWrapper</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="3">
        
        <div class="doc">
            <p>Args:</p>
<ul>
<li><code>cfg (omegaconf.DictConfig)</code>: <ul>
<li>Configuration dictionary created by Hydra based on the given configuration .yaml file</li>
</ul>
</li>
<li><code>mode (str)</code>: <ul>
<li>Mode indicating if process is running a training, evaluation or inference session.</li>
</ul>
</li>
</ul>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="4">
        
        <div class="doc">
            <p>In this method the incoming batch from the dataset is processed. If the batch is wrongly used, i.e. 
by using a wrong key for the dictionary, it will throw an error and terminate.</p>
<p>Args:</p>
<ul>
<li><code>batch (dict(torch.Tensor))</code>:<ul>
<li>Incoming batch from the dataset</li>
<li>The batch contains left and right rectified images and the reference disparity map.</li>
</ul>
</li>
</ul>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">set_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="5">
        
        <div class="doc">
            <p>The elements of the batch are, if wanted at all, moved to the GPU.  If the batch is processed in the wrong way, i.e. trying to access data by using a wrong key.  Tt will throw an error and terminate the task.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span>        <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;img_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">on_device</span><span class="p">)),</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;img_right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">on_device</span><span class="p">)),)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;disp_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">on_device</span><span class="p">)),</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">log_error</span><span class="p">(</span><span class="s2">&quot;[ModelWrapper] Unsupported access to current batch format. Check how the batch is made up in the dataset.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">omegaconf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ConfigAttributeError</span><span class="p">:</span>
            <span class="n">log_error</span><span class="p">(</span><span class="s2">&quot;[ModelWrapper] cfg.experiment.on_device in the configuration file is missing.&quot;</span><span class="p">)</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="6">
        
        <div class="doc">
            <p>Setting the loss function for the semantic segmentation task. In this case three different loss function are being used while training:</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">set_loss_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="7">
        
        <div class="doc">
            <p>Setting <code>self.final_loss</code> by computing the loss value. Previously defined functions from <code>set_loss_function()</code> will be used for that.</p>
<p>
<script type="math/tex; mode=display"> Loss = \lambda_0 l_\lambda + \lambda_1 l_1 + \lambda_2 l_2 + \lambda_3 l_3</script>
where
<script type="math/tex; mode=display">\lambda_3 = -\sum_{i, c}\{1:b_i>\tau\}(s_{i, c}logs_{i, c})</script>
with <script type="math/tex">\lambda_0=0.4, \lambda_1 = 20, \lambda_2 = 1, \lambda_3 = 1</script> and <script type="math/tex">\tau = 0.8</script>.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="8">
        
        <div class="doc">
            <p>Initializing of the optimizer. In this case it is the Adam optimizer with wight decay. Required information that needs to be defined in the configuration file is the start point of the learning rate.</p>
<p>Since this information is part of the optimizer the entry should <code>self.cfg.model_wrapper.optimizer.learning_rate</code>.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">set_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="9">
        
        <div class="doc">
            <p>Initializes the scheduler for the learning rate. In this case the OnPlateauLRScheduler is used that also takes into account the validation progress.</p>
<p>Additionally, a warmup phase was implemented for LRScheduler which is performed for the first 25 steps.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">set_learning_rate_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="10">
        
        <div class="doc">
            
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>        <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">OneCycleLR</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">init_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">max_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">model_wrapper</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader_training</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">sample_ratio_per_epoch</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="11">
        
        <div class="doc">
            <p>This function is called to update the learning rate according to the defined learning rate scheduler. Since OnPlateauLRScheduler is used which requires the information about the validation loss, the key-value pair <code>mean_valid_loss</code> must be given to the method call.</p>
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">update_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="section" id="12">
        
        <div class="doc">
            
        </div>
        
        
        <div class="code">
            <div class="highlight"><pre><span></span>        <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>

        </div>
        
    </div>
    
    <div class="footer">
        <a href="mailto:thomas.buechler@cariad.technology">Contact</a>
    </div>
    </div></body></html>
    